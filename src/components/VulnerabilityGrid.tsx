import { useEffect, useState } from 'react';

const vulnerabilities = [
  {
    id: 'A01',
    title: 'A01 - Broken Access Control',
    description: '✅ JWT tokens, rutas protegidas, verificación de autorización',
    borderColor: 'border-blue-600',
  },
  {
    id: 'A02',
    title: 'A02 - Cryptographic Failures',
    description: '✅ Bcrypt para passwords, conexión TLS/SSL a MongoDB',
    borderColor: 'border-purple-600',
  },
  {
    id: 'A03',
    title: 'A03 - Injection',
    description: '✅ Queries parametrizadas, validación y sanitización de inputs',
    borderColor: 'border-green-600',
  },
  {
    id: 'A04',
    title: 'A04 - Insecure Design',
    description: '✅ Arquitectura segura por diseño, validaciones en capas',
    borderColor: 'border-orange-600',
  },
  {
    id: 'A05',
    title: 'A05 - Security Misconfiguration',
    description: '✅ Helmet middleware, headers seguros, sin información sensible',
    borderColor: 'border-yellow-600',
  },
  {
    id: 'A06',
    title: 'A06 - Vulnerable Components',
    description: '✅ Dependencias actualizadas, versiones seguras',
    borderColor: 'border-cyan-600',
  },
  {
    id: 'A07',
    title: 'A07 - Identification Failures',
    description: '✅ Rate limiting, passwords fuertes, validación robusta',
    borderColor: 'border-red-600',
  },
  {
    id: 'A08',
    title: 'A08 - Integrity Failures',
    description: '✅ Validación de uploads, MIME types, procesamiento con Sharp',
    borderColor: 'border-indigo-600',
  },
  {
    id: 'A09',
    title: 'A09 - Logging Failures',
    description: '✅ Winston logger, registro de eventos de seguridad',
    borderColor: 'border-pink-600',
  },
];

export default function VulnerabilityGrid() {
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [showAlert, setShowAlert] = useState(false);
  const [clickedUrl, setClickedUrl] = useState('');

  useEffect(() => {
    // Verificar si hay token de sesión
    const token = localStorage.getItem('token');
    const tokenValid = token && token.length > 0 ? true : false;
    setIsAuthenticated(tokenValid);
  }, []);

  const handleProtectedClick = (e: React.MouseEvent, url: string) => {
    if (!isAuthenticated) {
      e.preventDefault();
      setClickedUrl(url);
      setShowAlert(true);
    }
  };

  return (
    <>
      {/* Alerta de autenticación requerida */}
      {showAlert && (
          <div className="mb-8 max-w-2xl mx-auto animate-fade-down animate-duration-1000">
            <div className="bg-yellow-500/10 backdrop-blur-md border border-yellow-500/30 rounded-xl p-5 shadow-lg">
              <div className="flex items-center justify-between gap-4">
                <div className="text-left flex-1">
                  <p className="font-bold text-yellow-300 mb-2 text-lg">
                    ⚠️ ¡Autenticación requerida!
                  </p>
                  <p className="text-gray-200 text-sm">
                    Necesitas{' '}
                    <a href={`/login?redirect=${encodeURIComponent(clickedUrl)}`} className="text-yellow-300 underline font-semibold hover:text-yellow-200 transition-colors">
                      iniciar sesión
                    </a>{' '}
                    o{' '}
                    <a href={`/register?redirect=${encodeURIComponent(clickedUrl)}`} className="text-yellow-300 underline font-semibold hover:text-yellow-200 transition-colors">
                      registrarte
                    </a>{' '}
                    para acceder a este contenido.
                  </p>
                </div>
                <button
                  onClick={() => setShowAlert(false)}
                  className="text-yellow-300 hover:text-white text-2xl font-bold cursor-pointer transition-colors bg-white/5 hover:bg-white/10 w-8 h-8 rounded-lg flex items-center justify-center"
                >
                  ×
                </button>
              </div>
            </div>
          </div>
        )}

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-9 max-w-6xl mx-auto">
        {vulnerabilities.map((vuln) => (
          <a
            key={vuln.id}
            href={`/vulnerabilities/${vuln.id}`}
            onClick={(e) => handleProtectedClick(e, `/vulnerabilities/${vuln.id}`)}
            className={`block bg-white/5 backdrop-blur-sm p-6 rounded-lg shadow-md border-l-4 ${vuln.borderColor} hover:shadow-lg hover:bg-white/10 transition-all cursor-pointer`}
          >
            <h3 className="text-xl font-bold mb-2 text-white">
              {vuln.title}
            </h3>
            <p className="text-gray-300">
              {vuln.description}
            </p>
          </a>
        ))}
      </div>
    </>
  );
}